<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ƒê∆°n h√†ng ShopeeFood</title>
    <!-- Chosen Palette: Neutral Harmony (Tailwind Gray) with Warm Accent (Tailwind Amber) -->
    <!-- Application Structure Plan: A tabbed single-page application. The structure is designed for a task-oriented user flow. 1) 'T·ªïng quan' for high-level analysis and business insights. 2) 'Danh s√°ch ƒê∆°n h√†ng' for detailed data exploration and lookup. 3) 'Th√™m ƒê∆°n h√†ng' for the data input task. This separation prevents cognitive overload and guides the user naturally from data entry to analysis. This standalone version requires user-provided Firebase config to run on any hosting. -->
    <!-- Visualization & Content Choices: Report Info (ShopeeFood Orders) -> Goal (Analyze sales, identify trends, view details) -> Viz/Presentation (KPI Cards for at-a-glance metrics; Line Chart for time-series trend analysis; Bar Chart for categorical comparison of top products; Interactive Table for deep data diving) -> Interaction (Tab navigation for task separation; Live search for filtering; Multi-image upload for efficient input) -> Justification (This combination provides a multi-layered analytical experience, from a 10,000-foot view down to individual order details, all within a single, cohesive interface) -> Library/Method (Chart.js for dynamic, canvas-based charts; Firestore for data persistence; Tailwind CSS for layout). -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', 'Be Vietnam Pro', sans-serif; }
        .tab-button.active { border-color: #f59e0b; color: #f59e0b; background-color: #fffbeb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col justify-center items-center z-50 p-4">
        <div style="border: 5px solid #f3f3f3; border-top: 5px solid #f59e0b; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
        <p id="loading-text" class="mt-4 text-gray-600 font-medium text-center">ƒêang kh·ªüi t·∫°o ·ª©ng d·ª•ng...</p>
    </div>

    <main id="main-content" class="container mx-auto p-4 md:p-6 opacity-0 transition-opacity duration-500">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-amber-600">Dashboard Kinh doanh</h1>
            <p class="text-gray-600 mt-2">Ph√¢n t√≠ch v√† tr·ª±c quan h√≥a d·ªØ li·ªáu ƒë∆°n h√†ng ShopeeFood c·ªßa b·∫°n.</p>
        </header>

        <div class="sticky top-0 bg-gray-50/80 backdrop-blur-sm z-10 py-2">
            <nav class="flex justify-center border-b border-gray-200" aria-label="Tabs">
                <button data-tab="dashboard" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-amber-600 transition-colors duration-200">üìä T·ªïng quan</button>
                <button data-tab="orders" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-amber-600 transition-colors duration-200">üìã Danh s√°ch ƒê∆°n h√†ng</button>
                <button data-tab="add" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-amber-600 transition-colors duration-200">‚ûï Th√™m ƒê∆°n h√†ng</button>
            </nav>
        </div>

        <div class="mt-6">
            <section id="dashboard-content" class="tab-content active">
                <div class="text-center max-w-3xl mx-auto mb-8"><h2 class="text-2xl font-semibold">B·∫£ng ƒëi·ªÅu khi·ªÉn trung t√¢m</h2><p class="mt-2 text-gray-600">ƒê√¢y l√† n∆°i cung c·∫•p c√°i nh√¨n t·ªïng th·ªÉ v·ªÅ t√¨nh h√¨nh kinh doanh c·ªßa b·∫°n. C√°c ch·ªâ s·ªë ch√≠nh (KPIs) cho th·∫•y hi·ªáu su·∫•t t·ª©c th√¨, trong khi c√°c bi·ªÉu ƒë·ªì gi√∫p b·∫°n nh·∫≠n di·ªán xu h∆∞·ªõng doanh thu v√† kh√°m ph√° nh·ªØng s·∫£n ph·∫©m ƒëang ƒë∆∞·ª£c ∆∞a chu·ªông nh·∫•t.</p></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><h3 class="text-gray-500 text-sm font-medium">T·ªïng Doanh thu</h3><p id="kpi-revenue" class="text-3xl font-bold text-gray-800 mt-1">0ƒë</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><h3 class="text-gray-500 text-sm font-medium">T·ªïng s·ªë ƒê∆°n h√†ng</h3><p id="kpi-orders" class="text-3xl font-bold text-gray-800 mt-1">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><h3 class="text-gray-500 text-sm font-medium">Kh√°ch h√†ng</h3><p id="kpi-customers" class="text-3xl font-bold text-gray-800 mt-1">0</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><h3 class="font-semibold mb-4 text-center">Doanh thu theo ng√†y</h3><div class="chart-container"><canvas id="revenue-chart"></canvas></div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><h3 class="font-semibold mb-4 text-center">Top s·∫£n ph·∫©m b√°n ch·∫°y</h3><div class="chart-container"><canvas id="products-chart"></canvas></div></div>
                </div>
            </section>

            <section id="orders-content" class="tab-content">
                 <div class="text-center max-w-3xl mx-auto mb-8"><h2 class="text-2xl font-semibold">Tra c·ª©u ƒê∆°n h√†ng</h2><p class="mt-2 text-gray-600">Khu v·ª±c n√†y cho ph√©p b·∫°n xem l·∫°i to√†n b·ªô l·ªãch s·ª≠ ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ. S·ª≠ d·ª•ng √¥ t√¨m ki·∫øm ƒë·ªÉ nhanh ch√≥ng l·ªçc ra c√°c ƒë∆°n h√†ng theo s·ªë ƒëi·ªán tho·∫°i c·ªßa kh√°ch, gi√∫p b·∫°n d·ªÖ d√†ng tra c·ª©u v√† qu·∫£n l√Ω th√¥ng tin chi ti·∫øt.</p></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <input type="text" id="search-input" placeholder="T√¨m theo SƒêT kh√°ch h√†ng..." class="w-full md:w-1/3 p-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="py-3 px-6">Ng√†y ƒë·∫∑t</th><th class="py-3 px-6">SƒêT Kh√°ch</th><th class="py-3 px-6">ƒê∆°n h√†ng</th><th class="py-3 px-6 text-right">T·ªïng ti·ªÅn</th></tr></thead><tbody id="orders-table-body"></tbody></table></div>
                </div>
            </section>

            <section id="add-content" class="tab-content">
                <div class="text-center max-w-3xl mx-auto mb-8"><h2 class="text-2xl font-semibold">Nh·∫≠p li·ªáu ƒê∆°n h√†ng</h2><p class="mt-2 text-gray-600">ƒê√¢y l√† c√¥ng c·ª• gi√∫p b·∫°n s·ªë h√≥a c√°c ƒë∆°n h√†ng. Ch·ªâ c·∫ßn t·∫£i l√™n m·ªôt ho·∫∑c nhi·ªÅu ·∫£nh ch·ª•p m√†n h√¨nh t·ª´ ·ª©ng d·ª•ng ShopeeFood Merchant, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông s·ª≠ d·ª•ng AI ƒë·ªÉ ƒë·ªçc, tr√≠ch xu·∫•t v√† l∆∞u tr·ªØ th√¥ng tin v√†o c∆° s·ªü d·ªØ li·ªáu c·ªßa b·∫°n.</p></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div id="upload-area"><div id="image-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-amber-50 transition-colors duration-200"><input type="file" id="image-upload" class="hidden" accept="image/*" multiple><label for="image-upload" class="cursor-pointer"><svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg><p class="mt-2 text-sm text-gray-600"><span class="font-semibold text-amber-600">Nh·∫•p ƒë·ªÉ ch·ªçn nhi·ªÅu ·∫£nh</span> ho·∫∑c k√©o th·∫£</p><p class="text-xs text-gray-500">H·ªó tr·ª£ PNG, JPG, JPEG</p></label></div></div>
                    <div id="results-area" class="hidden"><h3 class="font-bold text-lg mb-4">K·∫øt qu·∫£ x·ª≠ l√Ω:</h3><ul id="results-list" class="space-y-2"></ul><button id="reset-button" class="hidden w-full mt-6 bg-amber-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors">T·∫£i l√™n ƒë·ª£t kh√°c</button></div>
                </div>
            </section>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ===================================================================================
        // C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCe4ZmEkZlV_whsXnvQtd92R-lzCzoLR-U",
            authDomain: "shopee-6c5d8.firebaseapp.com",
            projectId: "shopee-6c5d8",
            storageBucket: "shopee-6c5d8.appspot.com",
            messagingSenderId: "192734037256",
            appId: "1:192734037256:web:bf2fda659012577a1418bd",
            measurementId: "G-NV4XDPJ4S3"
        };
        // ===================================================================================

        let db, auth, userId, allOrders = [], revenueChart, productsChart;

        const ui = {
            loadingScreen: document.getElementById('loading-screen'),
            loadingText: document.getElementById('loading-text'),
            mainContent: document.getElementById('main-content'),
            tabButtons: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            uploadArea: document.getElementById('upload-area'),
            resultsArea: document.getElementById('results-area'),
            imageDropZone: document.getElementById('image-drop-zone'),
            imageUpload: document.getElementById('image-upload'),
            resultsList: document.getElementById('results-list'),
            resetButton: document.getElementById('reset-button'),
            searchInput: document.getElementById('search-input'),
            ordersTableBody: document.getElementById('orders-table-body'),
            kpi: { revenue: document.getElementById('kpi-revenue'), orders: document.getElementById('kpi-orders'), customers: document.getElementById('kpi-customers'), },
            charts: { revenue: document.getElementById('revenue-chart').getContext('2d'), products: document.getElementById('products-chart').getContext('2d'), }
        };

        function initializeAppLogic() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                showError("L·ªñI: Ch∆∞a c√≥ c·∫•u h√¨nh Firebase. Vui l√≤ng l√†m theo h∆∞·ªõng d·∫´n v√† d√°n `firebaseConfig` c·ªßa b·∫°n v√†o trong file HTML.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        ui.loadingScreen.classList.add('hidden');
                        ui.mainContent.style.opacity = 1;
                        setupRealtimeListener();
                    }
                });
                signInAnonymously(auth).catch(error => showError("L·ªói ƒëƒÉng nh·∫≠p: " + error.message));
            } catch (error) { showError("L·ªói kh·ªüi t·∫°o: " + error.message); }
        }
        
        function showError(message) { ui.loadingText.innerHTML = `<span class="text-red-600">${message}</span>`; }

        function setupRealtimeListener() {
            const ordersCollection = collection(db, `users/${userId}/orders`);
            const q = query(ordersCollection, orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllComponents();
            }, error => console.error("L·ªói khi nghe d·ªØ li·ªáu:", error));
        }

        function renderAllComponents() {
            renderOrdersTable(allOrders);
            updateKPIs(allOrders);
            updateRevenueChart(allOrders);
            updateProductsChart(allOrders);
        }

        function renderOrdersTable(orders) {
            ui.ordersTableBody.innerHTML = '';
            if (orders.length === 0) { ui.ordersTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o. H√£y qua tab 'Th√™m ƒê∆°n h√†ng' ƒë·ªÉ b·∫Øt ƒë·∫ßu.</td></tr>`; return; }
            orders.forEach(order => {
                const itemsHtml = (order.items || []).map(item => `<div>${item.quantity} x ${item.name}</div>`).join('');
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                row.innerHTML = `<td class="py-4 px-6">${order.dateTime}</td><td class="py-4 px-6 font-medium">${order.customerPhone}</td><td class="py-4 px-6">${itemsHtml}</td><td class="py-4 px-6 font-medium text-right">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(order.totalPrice || 0)}</td>`;
                ui.ordersTableBody.appendChild(row);
            });
        }

        function updateKPIs(orders) {
            ui.kpi.revenue.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(orders.reduce((sum, order) => sum + (order.totalPrice || 0), 0));
            ui.kpi.orders.textContent = orders.length;
            ui.kpi.customers.textContent = new Set(orders.map(o => o.customerPhone)).size;
        }

        function updateRevenueChart(orders) {
            const revenueByDay = orders.reduce((acc, order) => { const datePart = order.dateTime.split(' - ')[0]; acc[datePart] = (acc[datePart] || 0) + (order.totalPrice || 0); return acc; }, {});
            const sortedDates = Object.keys(revenueByDay).sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(ui.charts.revenue, { type: 'line', data: { labels: sortedDates, datasets: [{ label: 'Doanh thu', data: sortedDates.map(date => revenueByDay[date]), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.2 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function updateProductsChart(orders) {
            const productCounts = orders.flatMap(o => o.items || []).reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + item.quantity; return acc; }, {});
            const sortedProducts = Object.entries(productCounts).sort((a, b) => b[1] - a[1]).slice(0, 7);
            if (productsChart) productsChart.destroy();
            productsChart = new Chart(ui.charts.products, { type: 'bar', data: { labels: sortedProducts.map(p => p[0]), datasets: [{ label: 'S·ªë l∆∞·ª£ng b√°n', data: sortedProducts.map(p => p[1]), backgroundColor: '#fcd34d', borderColor: '#f59e0b', borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }

        ui.tabButtons.forEach(button => button.addEventListener('click', () => {
            ui.tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            ui.tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(button.dataset.tab + '-content').classList.add('active');
        }));

        ui.searchInput.addEventListener('input', e => renderOrdersTable(allOrders.filter(order => order.customerPhone.includes(e.target.value))));
        
        ui.imageDropZone.addEventListener('dragover', e => { e.preventDefault(); ui.imageDropZone.classList.add('bg-amber-50', 'border-amber-400'); });
        ui.imageDropZone.addEventListener('dragleave', e => { e.preventDefault(); ui.imageDropZone.classList.remove('bg-amber-50', 'border-amber-400'); });
        ui.imageDropZone.addEventListener('drop', e => { e.preventDefault(); ui.imageDropZone.classList.remove('bg-amber-50', 'border-amber-400'); if (e.dataTransfer.files.length > 0) handleFileSelect({ target: { files: e.dataTransfer.files } }); });
        ui.imageUpload.addEventListener('change', handleFileSelect);
        ui.resetButton.addEventListener('click', () => { ui.resultsArea.classList.add('hidden'); ui.uploadArea.classList.remove('hidden'); ui.resultsList.innerHTML = ''; ui.imageUpload.value = ''; });

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            ui.uploadArea.classList.add('hidden'); ui.resultsArea.classList.remove('hidden'); ui.resetButton.classList.add('hidden');
            for (const file of files) {
                const li = document.createElement('li');
                li.className = 'p-3 bg-gray-100 rounded-lg flex items-center justify-between text-sm';
                li.innerHTML = `<span class="truncate pr-4">${file.name}</span><span class="status font-semibold text-gray-500">‚è≥ Ch·ªù x·ª≠ l√Ω...</span>`;
                ui.resultsList.appendChild(li);
            }
            for (let i = 0; i < files.length; i++) {
                try {
                    const base64ImageData = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); reader.readAsDataURL(files[i]); });
                    await extractAndSaveData(base64ImageData, ui.resultsList.children[i]);
                } catch (error) { updateStatus(ui.resultsList.children[i], '‚ùå L·ªói ƒë·ªçc file', 'error'); }
            }
            ui.resetButton.classList.remove('hidden');
        }

        function updateStatus(listItem, text, type) {
            const statusEl = listItem.querySelector('.status');
            statusEl.textContent = text;
            statusEl.className = 'status font-semibold';
            const colors = { processing: 'text-blue-600', success: 'text-green-600', error: 'text-red-600' };
            statusEl.classList.add(colors[type] || 'text-gray-500');
        }

        async function extractAndSaveData(base64ImageData, listItem) {
            updateStatus(listItem, '‚öôÔ∏è ƒêang ph√¢n t√≠ch...', 'processing');
            const apiKey = firebaseConfig.apiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const prompt = `Ph√¢n t√≠ch ·∫£nh ch·ª•p m√†n h√¨nh ƒë∆°n h√†ng ShopeeFood v√† tr√≠ch xu·∫•t th√¥ng tin d∆∞·ªõi d·∫°ng JSON. Ch·ªâ tr·∫£ v·ªÅ ƒë·ªëi t∆∞·ª£ng JSON.
                - dateTime: Ng√†y v√† gi·ªù ƒë·∫∑t h√†ng (VD: "25/06/2025 - 23:10").
                - customerPhone: S·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng.
                - totalPrice: T·ªïng s·ªë ti·ªÅn ƒë∆°n h√†ng, ch·ªâ l·∫•y s·ªë, kh√¥ng l·∫•y k√Ω t·ª± "ƒë".
                - items: M·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ d·∫°ng { "name": "T√™n m√≥n", "quantity": s·ªë_l∆∞·ª£ng }.`;

            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData.split(',')[1] } }] }], generationConfig: { responseMimeType: "application/json" } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error ${response.status}`);
                const result = await response.json();
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                updateStatus(listItem, '‚úÖ Ph√¢n t√≠ch xong, ƒëang l∆∞u...', 'processing');
                const orderData = { ...data, totalPrice: Number(data.totalPrice) || 0, createdAt: new Date().toISOString() };
                await addDoc(collection(db, `users/${userId}/orders`), orderData);
                updateStatus(listItem, '‚úÖ L∆∞u th√†nh c√¥ng!', 'success');
            } catch (error) {
                console.error("L·ªói khi tr√≠ch xu·∫•t ho·∫∑c l∆∞u:", error);
                if (error.message && error.message.includes('403')) {
                    updateStatus(listItem, '‚ùå L·ªói quy·ªÅn API (403)', 'error');
                } else {
                    updateStatus(listItem, '‚ùå L·ªói x·ª≠ l√Ω', 'error');
                }
            }
        }
        initializeAppLogic();
    </script>
</body>
</html>
